name: deploy mdbook github pages

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-22.04
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
    steps:
      - uses: actions/checkout@v4

      - name: setup mdbook
        uses: peaceiris/actions-mdbook@v1
        with:
          mdbook-version: '0.4.21'

      # If your book.toml has [build] build-dir = "public", this is fine.
      # Otherwise, add: run: mdbook build -d public
      - name: build
        run: mdbook build

      # Copy AFTER the build, because mdBook cleans the build dir.
      - name: copy resources into build output
        run: |
          mkdir -p public/res/img
          cp -r res/img/* public/res/img/ || true

      - name: deploy
        if: ${{ github.ref == 'refs/heads/main' }}
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.github_token }}
          publish_dir: ./public
